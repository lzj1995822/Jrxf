<!DOCTYPE html>
<html lang="cn">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>后台管理</title>

    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- basic styles -->

    <link href="Public/Plugin/style/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="Public/Plugin/style/css/font-awesome.min.css" />

    <link rel="stylesheet" href="Public/Plugin/style/css/font-awesome-ie7.min.css" />

    <link rel="stylesheet" href="Public/Plugin/style/css/ace.min.css" />
    <link rel="stylesheet" href="Public/Plugin/style/css/ace-rtl.min.css" />
    <link rel="stylesheet" href="Public/Plugin/style/css/ace-skins.min.css" />
    <link rel="stylesheet" href="../../static/fileinput.min.css" />
    <link rel="stylesheet" href="../../static/pagination.css" />
    <link rel="stylesheet" href="laydate/theme/default/laydate.css" />
    <script src="Public/Plugin/style/js/ace-extra.min.js"></script>
    <script type="text/javascript">
        window.jQuery || document.write("<script src='Public/Plugin/style/js/jquery-2.0.3.min.js'>"+"<"+"/script>");
    </script>
    <script type="text/javascript">
        if("ontouchend" in document) document.write("<script src='Public/Plugin/style/js/jquery.mobile.custom.min.js'>"+"<"+"/script>");
    </script>
    <script src="Public/Plugin/style/js/bootstrap.min.js"></script>
    <script src="Public/Plugin/style/js/typeahead-bs2.min.js"></script>
    <script src="Public/Plugin/style/js/jquery-ui-1.10.3.custom.min.js"></script>
    <script src="Public/Plugin/style/js/jquery.ui.touch-punch.min.js"></script>
    <script src="Public/Plugin/style/js/jquery.slimscroll.min.js"></script>
    <script src="Public/Plugin/style/js/jquery.easy-pie-chart.min.js"></script>
    <script src="Public/Plugin/style/js/jquery.sparkline.min.js"></script>
    <script src="Public/Plugin/style/js/flot/jquery.flot.min.js"></script>
    <script src="Public/Plugin/style/js/flot/jquery.flot.pie.min.js"></script>
    <script src="Public/Plugin/style/js/flot/jquery.flot.resize.min.js"></script>
    <script src="Public/Plugin/style/js/ace-elements.min.js"></script>
    <script src="Public/Plugin/style/js/ace.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="../../static/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="../../static/ueditor/ueditor.all.js"> </script>
    <script type="text/javascript" charset="utf-8" src="../../static/ueditor/lang/zh-cn/zh-cn.js"></script>
    <script type="text/javascript" charset="utf-8" src="../../static/fileinput.min.js"></script>
    <script type="text/javascript" charset="utf-8" src="../../static/fileinput_locale_zh.js"></script>
    <script type="text/javascript" charset="utf-8" src="../../static/jquery.pagination.js"></script>
    <script src="Public/Plugin/style/js/ractive-legacy.js"></script>
    <script src="laydate/laydate.js"></script>
</head>
<body>
<div class="col-sm-12 widget-container-span">
    <div class="widget-box transparent">
        <div class="widget-header">
            <div class="widget-toolbar no-border">
                <ul class="nav nav-tabs" id="myTab">
                    <li class="active" id="gl"><a href="remember_mission.html">管理</a></li>
                    <li id="xgtj"><a data-toggle="tab" href="#home2" >添加/修改</a></li>
                    </li>
                </ul>
            </div>
            <div style="clear:both;"></div>
            <div style="margin:20px 0px;">
                标题<input type="text" value="" name="name" placeholder="输入标题" id="name"/>
                <input type="button" value="查询" style="height:30px;" id="search"/>
            </div>
        </div>

        <div class="widget-body">
            <div class="widget-main padding-12 no-padding-left no-padding-right">
                <div class="tab-content padding-4">
                    <div id="home1" class="tab-pane in active">
                        <div class="row">
                            <div class="col-xs-12 no-padding-right">
                                <div class="table-responsive">
                                    <table id="sample-table-1"
                                           class="table table-striped table-bordered table-hover">
                                        <thead>
                                        <tr>
                                            <th>序号</th>
                                            <th>标题</th>
                                            <th>类型</th>
                                            <th>发布人</th>
                                            <th>发布时间</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody id="lawContainer">

                                        </tbody>
                                    </table>
                                    <div class="m-style" style="display: block;float: right">
                                        <nav aria-label="Page navigation">
                                            <div id="Pagination1" class="pagination mst">

                                            </div>
                                        </nav>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="home2" class="tab-pane in">
                        <div class="tabbable">
                            <div class="tab-content">
                                <div class="tab-pane active">
                                    <table cellpadding="2" cellspacing="2" width="100%">
                                        <tbody>
                                        <tr>
                                            <td>标题:</td>
                                            <td><input type="text" class="input col-sm-6" name="addname" value="" id="mc"></td>
                                        </tr>
                                        <tr>
                                            <td>类型:</td>
                                            <td>
                                                <select class="select_2" name="addmenuid" id="fl">
                                                    <option value="中央精神"> 中央精神</option>
                                                    <option value="市委部署"> 市委部署</option>
                                                    <option value="工作动态"> 工作动态</option>
                                                    <option value="学习研讨"> 学习研讨</option>
                                                    <option value="检视整改">&nbsp;检视整改</option>
                                                    <option value="优秀楷模">&nbsp;优秀楷模</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>图片:</td>
                                            <td><div style="width: 21.6%;display: inline-block;">
                                                <input id="fujian" name="fujian" type="file" style="width: 50%;">
                                            </div>
                                                <p class="help-block" id="addimage"><span style="color: #ff0000;">建议尺寸620*464</span>允许的附件文件类型: jpg,gif,png,jpeg并且图片大小小于200k.</p></td>
                                        </tr>
                                        <tr>
                                            <td>内容:</td>
                                            <td><!-- style给定宽度可以影响编辑器的最终宽度 -->
                                                <script id="editor" type="text/plain" style="width:660px;height:240px;"></script>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>发布时间:</td>
                                            <td><input type="text" class="input col-sm-2" name="addsort" value="" id="fbsj"></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary btn_submit J_ajax_submit_btn"
                                    type="button" onclick="tj()">提交</button>
                            <a class="btn" href="">返回</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script type="text/ractive" id="lawTemplate">
        {{#each data:i}}
        <tr>
            <td>{{i+1}}</td>
            <td>{{data[i].title}}</td>
            <td>{{data[i].type}}</td>
            <td>{{data[i].author}}</td>
            <td>{{data[i].createTime}}</td>
            <td>
                <a href="javascript:void(0);" on-click="xg" class="btn btn-white btn-sm" data-toggle="tab" href="#home2">修改</a>
                <a class="J_ajax_del btn btn-white btn-sm" on-click="sc" href="javascript:void(0);">删除</a>
            </td>
        </tr>
        {{/each}}
		</script>
        <script type="text/javascript">
            var url = "http://"+ window.location.host;
            laydate.render({
                elem: '#fbsj'
                ,type: 'datetime'
            });
            var address_app = function () {
                var pageSize = 15;
                var page = 1;
                function renderView() {
                    ractive = new Ractive({
                        el: "#lawContainer",
                        template: "#lawTemplate",
                        data: {
                            formatD: function (d) {
                                if (d) {
                                    return moment(d).format("YYYY-MM-DD HH:mm:ss");
                                }
                            }
                        },
                        oncomplete: function () {
                            $("#search").click(function(){
                                getDataList(1)
                            })
                            getDataList(1)
                        }
                    })
                    ractive.on({
                        sc: function (e) {
                            $.ajax({
                                url: url + "/rememberMission/" + e.context.id,
                                type: "Delete",
                                success: function (data) {
                                    if(data.result){
                                        getDataList(1);
                                        alert("删除成功！")
                                    }
                                }
                            });
                        },
                        xg:function(e){
                            $("#gl").removeClass("active");
                            $("#xgtj").addClass("active");
                            $("#home2").attr("code",e.context.id)
                            $("#mc").val(e.context.title)
                            $("#px").val(e.context.type)
                            $("#fbsj").val(e.context.createTime)
                            if (e.context.content) {
                                UE.getEditor('editor').setContent(e.context.content)
                            }
                            console.log(e.context.id, $("#home2").attr("code"));
                            $(".select_2").find("option[value='"+e.context.type+"']").attr("selected",true);
                            if(e.context.pic){
                                var _url = url + '/file/'+e.context.pic
                                $("#addimage").parent().append('<img code="'+e.context.pic+'" src="'+_url+'" id="goodimage" width="210" height="280" class="img-thumbnail">');
                            }
                        }
                    })
                    function getDataList(currPage){
                        var param ={};
                        param.page = {
                            page: currPage,
                            pageSize: pageSize,
                            start: (currPage - 1) * pageSize
                        }
                        param.title = $("#name").val();
                        $.ajax({
                            url: url + "/rememberMission/page",
                            type: "post",
                            data: JSON.stringify(param),
                            dataType: "json",
                            contentType: "application/json",
                            success: function (response) {
                                if(response){
                                    console.log(response,"123")
                                    ractive.set("data",response.obj.data)
                                    $("#Pagination1").pagination(
                                        {
                                            pageCount: Math.ceil(response.obj.total / pageSize),
                                            totalData: response.obj.total,
                                            showData: pageSize,
                                            current:currPage,
                                            callback: function (api) {
                                                getDataList(api.getCurrent())
                                            }//回调函数
                                        });
                                }

                            }
                        })

                    }
                }

                return {
                    init: function () {
                        renderView();
                    },
                    search:function(){
                        getDataList(1)
                    }
                }
            }();
            $(document).ready(address_app.init)
            var ue = UE.getEditor('editor');
            UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
            UE.Editor.prototype.getActionUrl = function(action) {
                if (action == 'uploadimage' || action == 'uploadscrawl' || action == 'uploadimage' || action=='uploadfile') {
                    return url+'/imgUpload';
                }else{
                    return this._bkGetActionUrl.call(this, action);
                }
            }
            var p ;
            var file="";
            var setting = {
                language: 'zh', //设置语言
                uploadUrl: "../../../file/fileUpload?id=fujian", //上传的地址(访问接口地址)
                allowedFileExtensions: ['jpg', 'png','gif','jpeg'],//接收的文件后缀
                uploadAsync: true, //默认异步上传
                showUpload: true, //是否显示上传按钮
                showRemove: true, //显示移除按钮
                showPreview: false, //是否显示预览
                showCaption: true,//是否显示标题
                browseClass: "btn btn-primary butt butthov", //按钮样式
                dropZoneEnabled: false,//是否显示拖拽区域
                maxFileCount: 1, //表示允许同时上传的最大文件个数
                enctype: 'multipart/form-data',
                validateInitialCount: true,
                previewFileIcon: "<i class='glyphicon glyphicon-king'></i>",
                msgFilesTooMany: "选择上传的文件数量({n}) 超过允许的最大数值{m}！"
            };
            $('#fujian').fileinput(setting).on("fileuploaded", function (event, data, previewId, index) {
                p = data.response.obj;
            });
            function tj(){
                var param={};
                var id = $("#home2").attr("code")
                param.type = $("#fl").val();
                param.title = $("#mc").val();
                param.pic = p;
                param.createTime = $("#fbsj").val();
                param.content = UE.getEditor('editor').getContent();
                if(id){
                    if(!p){
                        param.pic = $("#goodimage").attr("code")
                    }
                    param.id=id;
                    $.ajax({
                        url: url + "/rememberMission/" + id,
                        type: "Put",
                        data: JSON.stringify(param),
                        dataType: "json",
                        contentType: "application/json",
                        success: function (response) {
                            if(response.result){
                                alert("文章修改成功！")
                                window.location.href="remember_mission.html";
                            }else{
                                alert("操作失败！")
                            }

                        }
                    });
                }else{
                    $.ajax({
                        url: url + "/rememberMission/",
                        type: "post",
                        data: JSON.stringify(param),
                        dataType: "json",
                        contentType: "application/json",
                        success: function (response) {
                            if(response.result){
                                alert("文章新建成功！")
                                window.location.href="remember_mission.html";
                            }else{
                                alert("操作失败！")
                            }

                        }
                    });
                }
            }
        </script>
    </div>
</div>